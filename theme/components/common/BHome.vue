<script setup lang="ts">
import { useMouseInElement } from "@vueuse/core";
import { useData } from "vitepress";
import { onMounted, ref, toRefs, watch, watchEffect } from "vue";
import { isSidebarSingle } from "../../utils/sidebar";
import BButton from "./BButton.vue";
import BCow from "./BCow.vue";
import BLink from "./BLink.vue";
import type { SidebarItem, SidebarSingle, ThemeConfig } from "../../types";

const { frontmatter, theme } = useData<ThemeConfig>();

const { sidebar } = toRefs(theme.value);

// TODO custom with frontmatter
// TODO responsive style
watchEffect(() => {
  console.log(frontmatter.value);
});

const shakeElRef = ref<HTMLSpanElement>();
onMounted(() => {
  const shakeEl = shakeElRef.value;
  if (shakeEl) {
    shakeEl.classList.add("hover");
    setTimeout(() => {
      shakeEl.classList.remove("hover");
    }, 870);
  }
});

const { isOutside } = useMouseInElement(shakeElRef);
watch(isOutside, (isOutside) => {
  if (!isOutside) {
    shakeElRef.value?.classList.add("hover");
  } else {
    shakeElRef.value?.classList.remove("hover");
  }
}, { immediate: true });

function randomPick<T>(arr: T[]) {
  const day = Number(`${new Date().getFullYear()}${new Date().getMonth() + 1}${new Date().getDate()}`);
  return arr[day % arr.length];
}

function lookAround() {
  if (!sidebar?.value) {
    return "/";
  }
  let sidebarSingle: SidebarSingle;
  if (isSidebarSingle(sidebar.value)) {
    sidebarSingle = sidebar.value;
  } else {
    sidebarSingle = sidebar.value[randomPick(Object.keys(sidebar.value))];
  }

  function pick(sidebarItem: SidebarItem) {
    if (sidebarItem.items?.length) {
      return pick(randomPick(sidebarItem.items));
    }
    return sidebarItem.link;
  }

  if (Array.isArray(sidebarSingle)) {
    return pick(randomPick(sidebarSingle));
  }
  return pick(randomPick(sidebarSingle.items));
}
</script>

<template>
  <div class="grid mx-auto h-full max-w-[var(--b-max-width)] min-h-[calc(100vh_-_var(--b-nav-height)_-_var(--b-footer-height))] w-full p-xs">
    <div class="h-full flex flex-col items-center justify-center gap-sm">
      <h1 class="text-6xl">
        <span ref="shakeElRef" class="shake inline-block cursor-default select-none">
          👋
        </span>
      </h1>
      <h1 class="text-3xl font-bold">
        我是科科
      </h1>
      <div class="text-muted-foreground">
        <ruby>
          什么也不会，喜欢睡觉
          <rt>
            <samp>Knows nothing, likes sleeping.</samp>
          </rt>
        </ruby>
      </div>
      <BCow />
      <div class="flex items-center gap-xs">
        <BLink :href="lookAround()">
          <BButton class="rounded-full px-lg" as="div">
            随便看看
          </BButton>
        </BLink>
        <BLink href="https://github.com/Bernankez/blog" target="_blank">
          <BButton variant="secondary" class="rounded-full px-lg">
            GitHub
          </BButton>
        </BLink>
      </div>
    </div>
  </div>
</template>

<style scoped>
.shake.hover {
  animation: shake 0.82s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
  transform: translate3d(0, 0, 0);
  backface-visibility: hidden;
  perspective: 1000px;
}

@keyframes shake {
  10%,
  90% {
    transform: translate3d(-1px, 1px, 0);
  }

  20%,
  80% {
    transform: translate3d(2px, -2px, 0);
  }

  30%,
  50%,
  70% {
    transform: translate3d(-4px, 4px, 0);
  }

  40%,
  60% {
    transform: translate3d(4px, -4px, 0);
  }
}
</style>
